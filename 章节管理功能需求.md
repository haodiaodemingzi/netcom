# 章节管理功能需求文档

## 一、章节分类与展示

### 1.1 标签页切换
- **实现方式**: 使用 Tab 标签页切换"卷"和"章节"两个分类
- **默认显示**: 根据漫画内容自动判断，如果有卷则默认显示"卷"标签，否则显示"章节"
- **标签位置**: 在章节列表顶部，排序按钮下方
- **交互**: 点击标签切换，当前标签高亮显示

### 1.2 章节排序
- **默认排序**: 降序（从最新章节到最早章节）
- **排序选项**:
  - 降序：最新章节在前
  - 升序：最早章节在前
- **排序方式**: 按章节编号数字排序
- **排序按钮**: 保留在右上角，点击切换正序/倒序

## 二、批量下载功能

### 2.1 下载选择
- **选择模式**: 点击"批量下载"按钮进入选择模式
- **选择方式**:
  - 单选：点击章节卡片左侧复选框
  - 全选：点击顶部"全选"按钮
  - 范围选择（可选）：长按章节后拖动选择连续章节

### 2.2 下载执行
- **触发**: 点击"下载"按钮开始下载
- **下载内容**: 下载选中章节的所有图片
- **存储位置**: 
  - 移动端：应用私有存储目录 `/[漫画名称]/[章节名称]/[页码].jpg`
  - 格式：`/netcom/downloads/[漫画ID]/[章节ID]/001.jpg`

### 2.3 下载进度显示

#### 总体进度
- **位置**: 页面顶部固定位置或底部浮动条
- **显示内容**:
  - 当前下载章节名称
  - 总进度：已完成章节/总章节数
  - 百分比进度条
  - 下载速度（可选）
  - 预计剩余时间（可选）

#### 单章节进度
- **显示位置**: 每个章节卡片上
- **状态标识**:
  - 等待下载：灰色图标
  - 下载中：蓝色进度环 + 百分比
  - 已完成：绿色勾选图标
  - 下载失败：红色感叹号 + 重试按钮

### 2.4 下载管理
- **后台下载**: 
  - 支持后台下载，切换页面不中断
  - 关闭应用后暂停，重新打开继续
- **并发控制**: 同时下载 3-5 个章节，避免请求过多
- **失败重试**: 
  - 自动重试 3 次
  - 失败后显示重试按钮，支持手动重试
- **下载暂停/继续**: 
  - 提供暂停按钮
  - 支持暂停后继续下载

### 2.5 已下载章节标识
- **图标标识**: 已下载章节显示"已下载"徽章（绿色）
- **离线阅读**: 点击已下载章节直接读取本地文件
- **下载管理入口**: 
  - 在设置中添加"下载管理"
  - 显示所有已下载漫画和章节
  - 支持删除已下载内容

## 三、UI/UX 设计

### 3.1 章节列表布局
```
┌─────────────────────────────────────┐
│  章节列表 (50)            批量下载 ↓ │ ← 头部
├─────────────────────────────────────┤
│  [卷]  [章节]                        │ ← Tab 标签
├─────────────────────────────────────┤
│  ┌─────────────────────────────┐   │
│  │ □ 第1话 标题              › │   │ ← 章节卡片
│  │   更新时间  [已下载]         │   │
│  └─────────────────────────────┘   │
│  ┌─────────────────────────────┐   │
│  │ □ 第2话 标题              › │   │
│  │   更新时间  [下载中 45%]    │   │
│  └─────────────────────────────┘   │
└─────────────────────────────────────┘
```

### 3.2 下载进度条
```
┌─────────────────────────────────────┐
│ 正在下载: 第5话                      │
│ ████████░░░░░░░░ 3/8章节 (45%)     │
│ [暂停] [取消]                        │
└─────────────────────────────────────┘
```

## 四、技术实现要点

### 4.1 数据存储
- 使用 AsyncStorage 存储下载任务列表
- 使用 expo-file-system 进行文件下载和管理
- 记录每个章节的下载状态和本地路径

### 4.2 下载队列
- 实现下载队列管理器
- 控制并发数量
- 处理失败重试逻辑

### 4.3 进度通知
- 使用 React Context 管理全局下载状态
- 实时更新 UI 进度显示
- 可选：使用通知栏显示后台下载进度

### 4.4 章节排序逻辑
```javascript
// 提取章节编号进行数字排序
const extractChapterNumber = (title) => {
  const match = title.match(/(\d+)/);
  return match ? parseInt(match[1], 10) : 0;
};

// 排序
chapters.sort((a, b) => {
  const numA = extractChapterNumber(a.title);
  const numB = extractChapterNumber(b.title);
  return sortOrder === 'desc' ? numB - numA : numA - numB;
});
```

## 五、开发优先级

### P0（必须实现）
1. Tab 标签页切换卷/章节
2. 按数字降序排列
3. 正反序切换
4. 基础下载功能
5. 下载进度显示

### P1（重要功能）
1. 已下载章节标识
2. 离线阅读本地文件
3. 下载失败重试
4. 后台下载支持

### P2（优化功能）
1. 下载速度显示
2. 预计剩余时间
3. 下载管理页面
4. 批量删除下载

## 六、需要确认的问题

1. **存储空间**: 是否需要限制下载容量上限？
2. **网络策略**: 是否仅在 WiFi 下自动下载？
3. **清理策略**: 是否自动清理旧的下载文件？
4. **下载源**: 使用哪个 API 接口下载图片？
5. **图片格式**: 是否需要压缩图片以节省空间？
