# 多数据源配置说明

## 功能概述

漫画阅读器现已支持多数据源切换功能,可以在配置文件中配置多个漫画数据源,用户可以在前端自由切换。

## 后端配置

### 1. 配置文件

在 `backend/config.py` 中配置数据源:

```python
COMIC_SOURCES = {
    'komiic': {
        'name': 'Komiic',
        'base_url': 'https://komiic.com',
        'enabled': True,
        'description': 'Komiic 漫画源',
    },
    'manhuagui': {
        'name': '漫画柜',
        'base_url': 'https://www.manhuagui.com',
        'enabled': True,
        'description': '漫画柜数据源',
    },
    'copymanga': {
        'name': '拷贝漫画',
        'base_url': 'https://www.copymanga.site',
        'enabled': True,
        'description': '拷贝漫画数据源',
    },
    'mock': {
        'name': '测试数据',
        'base_url': 'http://localhost',
        'enabled': True,
        'description': '模拟测试数据源',
    },
}

# 默认数据源
DEFAULT_SOURCE = 'mock'
```

### 2. 添加新数据源

#### 步骤1: 创建爬虫类

在 `backend/services/scraper.py` 中创建新的爬虫类:

```python
class NewScraper(BaseScraper):
    """新数据源爬虫"""
    
    def __init__(self):
        super().__init__('https://new-source.com')
    
    def get_hot_comics(self, page=1, limit=20):
        # 实现获取热门漫画逻辑
        pass
    
    def get_latest_comics(self, page=1, limit=20):
        # 实现获取最新漫画逻辑
        pass
    
    # ... 实现其他必需方法
```

#### 步骤2: 注册到工厂类

在 `backend/services/scraper_factory.py` 中注册:

```python
from .scraper import NewScraper

class ScraperFactory:
    _scrapers = {
        'komiic': KomiicScraper,
        'manhuagui': ManhuaguiScraper,
        'copymanga': CopymangaScraper,
        'mock': MockScraper,
        'newsource': NewScraper,  # 添加新数据源
    }
```

#### 步骤3: 添加到配置

在 `backend/config.py` 中添加配置:

```python
COMIC_SOURCES = {
    # ... 其他数据源
    'newsource': {
        'name': '新数据源',
        'base_url': 'https://new-source.com',
        'enabled': True,
        'description': '新数据源描述',
    },
}
```

### 3. 启用/禁用数据源

修改配置文件中的 `enabled` 字段:

```python
'komiic': {
    'name': 'Komiic',
    'enabled': False,  # 禁用此数据源
    # ...
},
```

## 前端使用

### 1. 获取可用数据源

```javascript
import { getAvailableSources } from '../services/api';

const sources = await getAvailableSources();
// 返回: { komiic: {...}, manhuagui: {...}, ... }
```

### 2. 切换数据源

```javascript
import { setCurrentSource } from '../services/storage';

// 保存当前选择的数据源
await setCurrentSource('manhuagui');
```

### 3. 使用指定数据源请求数据

所有 API 方法都支持传入 `source` 参数:

```javascript
import { getHotComics } from '../services/api';

// 使用指定数据源
const data = await getHotComics(1, 20, 'manhuagui');

// 使用默认数据源
const data = await getHotComics(1, 20);
```

### 4. 首页数据源切换

首页已集成数据源切换功能:
- 点击右上角的数据源按钮
- 选择想要的数据源
- 自动刷新数据

## API 接口

### 获取所有可用数据源

```
GET /api/sources
```

**响应**:
```json
{
  "mock": {
    "name": "测试数据",
    "description": "模拟测试数据源",
    "enabled": true
  },
  "komiic": {
    "name": "Komiic",
    "description": "Komiic 漫画源",
    "enabled": true
  }
}
```

### 使用指定数据源获取数据

所有漫画相关接口都支持 `source` 参数:

```
GET /api/comics/hot?source=manhuagui&page=1&limit=20
GET /api/comics/search?keyword=海贼王&source=copymanga
GET /api/comics/123?source=komiic
```

## 数据源架构

```
BaseScraper (基类)
├── KomiicScraper (Komiic)
├── ManhuaguiScraper (漫画柜)
├── CopymangaScraper (拷贝漫画)
└── MockScraper (测试数据)

ScraperFactory (工厂类)
└── 根据配置创建对应的爬虫实例
```

## 注意事项

1. **必须实现所有抽象方法**: 新的爬虫类必须实现 `BaseScraper` 中的所有抽象方法
2. **配置文件同步**: 确保 `config.py` 和 `scraper_factory.py` 中的数据源配置一致
3. **反爬虫策略**: 不同网站有不同的反爬虫机制,需要针对性处理
4. **错误处理**: 建议在爬虫类中添加完善的错误处理和日志记录
5. **缓存策略**: 不同数据源可能需要不同的缓存时间

## 测试

启动后端服务后,访问:

```bash
# 获取所有数据源
curl http://localhost:5000/api/sources

# 测试不同数据源
curl http://localhost:5000/api/comics/hot?source=mock
curl http://localhost:5000/api/comics/hot?source=manhuagui
```

## 常见问题

### Q: 如何临时禁用某个数据源?

A: 在 `config.py` 中将对应数据源的 `enabled` 设置为 `False`

### Q: 数据源切换后数据没有更新?

A: 检查缓存配置,可能需要清除缓存或调整缓存时间

### Q: 如何设置默认数据源?

A: 修改 `config.py` 中的 `DEFAULT_SOURCE` 配置

## 扩展建议

1. **数据源优先级**: 可以添加优先级配置,自动选择可用的数据源
2. **数据源健康检查**: 定期检查数据源可用性
3. **数据源统计**: 记录各数据源的使用情况和性能
4. **智能切换**: 当某个数据源失败时自动切换到其他数据源
