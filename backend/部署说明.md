# 漫画阅读器后端部署说明

## 🐳 方式一：Docker部署（推荐）

### 前置要求
- 安装Docker和Docker Compose

### 快速开始

```bash
cd backend

# 构建并启动
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

### 访问服务
- API地址: `http://your-server:5000`
- 测试接口: `http://your-server:5000/api/sources`

---

## 🔧 方式二：一键安装脚本

### 适用系统
- Ubuntu 18.04+
- Debian 10+
- CentOS 7+

### 安装步骤

```bash
cd backend

# 添加执行权限
chmod +x install.sh

# 运行安装脚本
sudo bash install.sh
```

### 脚本功能
- ✅ 自动检测操作系统
- ✅ 安装Python3和依赖
- ✅ 创建虚拟环境
- ✅ 配置环境变量
- ✅ 创建systemd服务
- ✅ 开机自启动

### 服务管理

```bash
# 启动服务
sudo systemctl start comic-backend

# 停止服务
sudo systemctl stop comic-backend

# 重启服务
sudo systemctl restart comic-backend

# 查看状态
sudo systemctl status comic-backend

# 查看日志
sudo journalctl -u comic-backend -f
```

---

## 📝 方式三：手动部署

### 1. 安装Python3

```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install python3 python3-pip python3-venv

# CentOS/RHEL
sudo yum install python3 python3-pip
```

### 2. 创建虚拟环境

```bash
cd backend
python3 -m venv venv
source venv/bin/activate
```

### 3. 安装依赖

```bash
pip install -r requirements.txt
```

### 4. 配置环境变量

```bash
cp .env.example .env
nano .env  # 编辑配置
```

### 5. 启动服务

```bash
# 前台运行
python app.py

# 后台运行
nohup python app.py > comic.log 2>&1 &
```

---

## ⚙️ 配置说明

### .env 文件

```env
# 代理配置（可选）
HTTP_PROXY=http://127.0.0.1:7890
HTTPS_PROXY=http://127.0.0.1:7890

# Flask配置
FLASK_ENV=production
FLASK_DEBUG=0

# 其他配置
PORT=5000
HOST=0.0.0.0
```

---

## 🔒 安全建议

### 1. 使用反向代理

推荐使用Nginx作为反向代理：

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location /api {
        proxy_pass http://localhost:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 2. 启用HTTPS

```bash
# 使用Let's Encrypt
sudo apt-get install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com
```

### 3. 防火墙配置

```bash
# 只允许本地访问后端
sudo ufw allow from 127.0.0.1 to any port 5000

# 或开放给所有人
sudo ufw allow 5000
```

---

## 🐛 故障排查

### 1. 端口被占用

```bash
# 查看端口占用
lsof -i :5000

# 修改端口
export PORT=5001
```

### 2. 依赖安装失败

```bash
# 使用国内镜像
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### 3. 权限问题

```bash
# 给予执行权限
chmod +x app.py
sudo chown -R $USER:$USER /path/to/backend
```

### 4. 查看日志

```bash
# Docker
docker-compose logs -f

# systemd
sudo journalctl -u comic-backend -f

# 文件
tail -f comic.log
```

---

## 📊 性能优化

### 1. 使用Gunicorn

```bash
pip install gunicorn

# 启动
gunicorn -w 4 -b 0.0.0.0:5000 app:app
```

### 2. 使用Redis缓存

```bash
# 安装Redis
sudo apt-get install redis-server

# 修改config.py启用Redis
```

---

## 🔄 更新部署

```bash
# Docker方式
docker-compose down
git pull
docker-compose up -d --build

# 脚本方式
sudo systemctl stop comic-backend
git pull
source venv/bin/activate
pip install -r requirements.txt
sudo systemctl start comic-backend

# 手动方式
kill $(cat comic.pid)  # 停止旧进程
git pull
source venv/bin/activate
pip install -r requirements.txt
nohup python app.py > comic.log 2>&1 &
```

---

## 📞 技术支持

如遇问题，请检查：
1. Python版本 >= 3.8
2. 网络连接正常
3. 端口未被占用
4. 依赖完整安装
5. 日志文件内容
