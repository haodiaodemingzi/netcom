# 数据源配置说明

## 📊 可用数据源对比

| 数据源 | 域名 | 需要代理 | 内容量 | 推荐环境 |
|--------|------|----------|--------|----------|
| **guoman8** | guoman8.cc | ❌ 不需要 | 丰富 | ⭐ 生产环境 |
| **xmanhua** | xmanhua.com | ✅ 需要 | 丰富 | 本地开发 |
| komiic | komiic.com | ✅ 需要 | 中等 | - |
| manhuagui | manhuagui.com | ✅ 需要 | 丰富 | - |
| copymanga | copymanga.site | ✅ 需要 | 丰富 | - |

---

## 🎯 推荐配置

### 生产服务器（默认）

```python
DEFAULT_SOURCE = 'guoman8'  # 不需要代理
```

**优势**:
- ✅ 无需配置代理
- ✅ 部署简单
- ✅ 访问稳定
- ✅ 内容丰富

---

### 本地开发（可选）

如果你有代理，可以使用xmanhua：

```python
DEFAULT_SOURCE = 'xmanhua'  # 需要代理
```

**前提**:
- 本地运行代理服务（如v2ray、clash）
- 代理端口: 7897（或修改config.py中的配置）

---

## ⚙️ 配置方法

### 方法1: 修改代码（简单）

编辑 `backend/config.py`:

```python
# 默认数据源
DEFAULT_SOURCE = 'guoman8'  # 或 'xmanhua'
```

---

### 方法2: 环境变量（灵活）

不修改代码，通过环境变量控制：

```bash
# 使用国漫8（生产环境）
export DEFAULT_SOURCE=guoman8
python app.py

# 使用X漫画（需要代理）
export DEFAULT_SOURCE=xmanhua
export USE_PROXY=true
export PROXY_HOST=127.0.0.1
export PROXY_PORT=7897
python app.py
```

---

### 方法3: systemd服务配置

编辑 `/etc/systemd/system/comic-backend.service`:

```ini
[Service]
Environment="DEFAULT_SOURCE=guoman8"
Environment="USE_PROXY=false"
```

---

## 🚀 生产部署建议

### 推荐配置

```bash
# 1. 使用国漫8数据源
DEFAULT_SOURCE=guoman8

# 2. 不使用代理
USE_PROXY=false

# 3. 部署
cd /root/src/netcom
git pull
cd backend
python3 app.py
```

这样可以保证：
- ✅ 稳定可靠
- ✅ 无需代理
- ✅ 维护简单

---

## 🔄 切换数据源

### 在APP中切换（用户可见）

用户可以在APP的设置页面选择数据源：
- 国漫8
- X漫画
- 其他数据源

后端会根据请求参数使用对应的数据源。

### 后端默认数据源

如果APP没有指定数据源，会使用 `DEFAULT_SOURCE`。

---

## 🐛 故障排查

### 问题1: 生产环境无数据

**症状**: 
```
成功获取热门漫画, 数量: 0
```

**原因**: xmanhua需要代理，但生产服务器没有代理

**解决**: 
```python
DEFAULT_SOURCE = 'guoman8'  # 改为国漫8
```

---

### 问题2: 本地开发无数据

**症状**: 使用guoman8时也获取不到数据

**原因**: 网络问题或网站维护

**解决**: 
1. 检查网络连接
2. 浏览器访问 https://www.guoman8.cc 确认网站正常
3. 查看后端日志

---

### 问题3: 代理配置无效

**症状**: 设置了代理但仍然无法访问xmanhua

**检查**:
```bash
# 1. 确认代理服务运行
curl -x http://127.0.0.1:7897 https://xmanhua.com

# 2. 检查代理配置
echo $USE_PROXY
echo $PROXY_HOST
echo $PROXY_PORT

# 3. 查看日志中是否显示"使用代理"
```

---

## 📝 完整示例

### 生产环境部署

```bash
#!/bin/bash
# deploy_production.sh

cd /root/src/netcom
git pull

cd backend

# 设置环境变量
export DEFAULT_SOURCE=guoman8
export USE_PROXY=false
export FLASK_ENV=production

# 启动服务
python3 app.py
```

---

### 本地开发

```bash
# local_dev.sh

cd c:\coding\netcom\backend

# 设置环境变量（如果有代理）
export DEFAULT_SOURCE=xmanhua
export USE_PROXY=true
export PROXY_HOST=127.0.0.1
export PROXY_PORT=7897

# 启动服务
python app.py
```

---

## 💡 最佳实践

1. **生产环境**: 使用 `guoman8`，不需要代理
2. **开发环境**: 根据实际情况选择
3. **代理配置**: 通过环境变量而不是硬编码
4. **数据源切换**: 让用户在APP中自由选择

---

## 🎯 当前配置总结

### 默认配置（已修改）

```python
# config.py
DEFAULT_SOURCE = os.getenv('DEFAULT_SOURCE', 'guoman8')
```

这意味着：
- **默认**: 使用国漫8（不需要代理）
- **可选**: 通过环境变量 `DEFAULT_SOURCE=xmanhua` 切换

### 代理配置

```python
# xmanhua数据源的代理配置
'proxy': {
    'enabled': os.getenv('USE_PROXY', 'false').lower() == 'true',
    'host': os.getenv('PROXY_HOST', '127.0.0.1'),
    'port': int(os.getenv('PROXY_PORT', '7897')),
    'type': os.getenv('PROXY_TYPE', 'http')
}
```

---

## ✅ 部署清单

生产环境部署前检查：

- [ ] 默认数据源设置为 `guoman8`
- [ ] 代理配置关闭（或通过环境变量控制）
- [ ] 拉取最新代码 `git pull`
- [ ] 安装依赖 `pip install -r requirements.txt`
- [ ] 测试API `curl http://localhost:5000/api/sources`
- [ ] 确认能获取数据 `curl http://localhost:5000/api/comics/hot`

完成！🎉
