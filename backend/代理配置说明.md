# 代理配置说明

## 概述

某些采集源（如X漫画）可能需要通过代理访问。系统已支持HTTP和SOCKS5代理配置。

## 配置方法

### 1. 在 config.py 中配置

```python
COMIC_SOURCES = {
    'xmanhua': {
        'name': 'X漫画',
        'base_url': 'https://www.xmanhua.com',
        'enabled': True,
        'description': 'X漫画网',
        'proxy': {
            'enabled': True,      # 是否启用代理
            'host': '127.0.0.1',  # 代理服务器地址
            'port': 7897,         # 代理端口
            'type': 'socks5'      # 代理类型: http, https, socks5
        }
    }
}
```

### 2. 代理类型

支持以下代理类型：
- **http**: HTTP代理
- **https**: HTTPS代理
- **socks5**: SOCKS5代理（推荐）

### 3. 常见代理配置

#### Clash代理
```python
'proxy': {
    'enabled': True,
    'host': '127.0.0.1',
    'port': 7897,
    'type': 'socks5'
}
```

#### V2Ray代理
```python
'proxy': {
    'enabled': True,
    'host': '127.0.0.1',
    'port': 10808,
    'type': 'socks5'
}
```

#### HTTP代理
```python
'proxy': {
    'enabled': True,
    'host': '127.0.0.1',
    'port': 8080,
    'type': 'http'
}
```

## 安装依赖

### SOCKS5代理支持

需要安装额外的依赖：

```bash
cd backend
py -3 -m pip install requests[socks]
```

或者使用豆瓣镜像：

```bash
py -3 -m pip install -i https://pypi.douban.com/simple requests[socks]
```

### 完整依赖安装

```bash
py -3 -m pip install -r requirements.txt
```

## 使用示例

### 启用代理

在 `config.py` 中设置 `enabled: True`：

```python
'proxy': {
    'enabled': True,
    'host': '127.0.0.1',
    'port': 7897,
    'type': 'socks5'
}
```

### 禁用代理

设置 `enabled: False` 或删除 `proxy` 配置：

```python
'proxy': {
    'enabled': False,
    # ...
}
```

或者：

```python
# 不配置 proxy 字段
'xmanhua': {
    'name': 'X漫画',
    'base_url': 'https://www.xmanhua.com',
    'enabled': True,
    'description': 'X漫画网',
    # 没有 proxy 配置
}
```

## 测试代理

### 1. 启动代理软件

确保代理软件（如Clash、V2Ray）正在运行，并监听指定端口。

### 2. 运行测试

```bash
cd backend
py -3 test_xmanhua.py
```

### 3. 查看输出

如果代理配置正确，会看到：

```
使用代理: socks5://127.0.0.1:7897
请求URL: https://www.xmanhua.com
```

## 常见问题

### Q1: SOCKS5代理不工作

**错误信息**:
```
Missing dependencies for SOCKS support
```

**解决方案**:
```bash
py -3 -m pip install pysocks
```

### Q2: 代理连接超时

**可能原因**:
1. 代理软件未启动
2. 端口配置错误
3. 防火墙阻止

**解决方案**:
1. 检查代理软件是否运行
2. 确认端口号正确
3. 检查防火墙设置

### Q3: 代理认证失败

如果代理需要用户名和密码，需要修改代理URL格式：

```python
# 在 base_scraper.py 中修改
proxy_url = f'{proxy_type}://{username}:{password}@{proxy_host}:{proxy_port}'
```

### Q4: 如何测试代理是否可用

使用curl测试：

```bash
# HTTP代理
curl -x http://127.0.0.1:7897 https://www.xmanhua.com

# SOCKS5代理
curl -x socks5://127.0.0.1:7897 https://www.xmanhua.com
```

## 性能优化

### 1. 连接池

代理会增加延迟，建议使用连接池：

```python
self.session = requests.Session()
adapter = requests.adapters.HTTPAdapter(
    pool_connections=10,
    pool_maxsize=20
)
self.session.mount('http://', adapter)
self.session.mount('https://', adapter)
```

### 2. 超时设置

增加超时时间：

```python
response = self.session.get(url, timeout=30, verify=verify_ssl)
```

### 3. 重试机制

添加自动重试：

```python
from requests.adapters import HTTPAdapter
from requests.packages.urllib3.util.retry import Retry

retry = Retry(
    total=3,
    backoff_factor=1,
    status_forcelist=[500, 502, 503, 504]
)
adapter = HTTPAdapter(max_retries=retry)
self.session.mount('http://', adapter)
self.session.mount('https://', adapter)
```

## 安全建议

1. **不要在代码中硬编码代理密码**
2. **使用环境变量存储敏感信息**
3. **定期更换代理服务器**
4. **使用可信的代理服务**

## 环境变量配置（可选）

可以使用环境变量配置代理：

```python
import os

proxy_config = {
    'enabled': os.getenv('PROXY_ENABLED', 'false').lower() == 'true',
    'host': os.getenv('PROXY_HOST', '127.0.0.1'),
    'port': int(os.getenv('PROXY_PORT', '7897')),
    'type': os.getenv('PROXY_TYPE', 'socks5')
}
```

然后在 `.env` 文件中配置：

```env
PROXY_ENABLED=true
PROXY_HOST=127.0.0.1
PROXY_PORT=7897
PROXY_TYPE=socks5
```

## 总结

- ✅ 支持HTTP、HTTPS、SOCKS5代理
- ✅ 配置简单，在config.py中设置
- ✅ 可以为每个数据源单独配置
- ✅ 自动处理代理连接
- ⚠️ 需要安装 `requests[socks]` 支持SOCKS5
- ⚠️ 确保代理软件正在运行
